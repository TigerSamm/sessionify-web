<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sessionify Help Center - walkthroughs, troubleshooting, and best practices for practitioners.">
    <title>Sessionify Help Center</title>
    <link rel="icon" type="image/png" href="../assets/favicon.png" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        };
    </script>
    <style>
        :root {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            min-height: 100vh;
            margin: 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border-radius: 999px;
            padding: 0.55rem 1.4rem;
            text-decoration: none;
            transition: transform 150ms ease, box-shadow 150ms ease, background-color 150ms ease, color 150ms ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18);
        }

        .btn-primary {
            background: linear-gradient(120deg, #6366f1 0%, #8b5cf6 100%);
            color: #fff;
        }

        .btn-secondary {
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: inherit;
            background-color: transparent;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid transparent;
            color: inherit;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.08);
            padding: 1.5rem;
        }

        .dark .card {
            background-color: rgba(15, 23, 42, 0.85);
            color: #e2e8f0;
        }

        .article-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        .article-content ul {
            list-style: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="antialiased bg-gray-50 text-gray-800 dark:bg-slate-900 dark:text-white transition-colors duration-300">
    <div id="root"></div>

    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" crossorigin></script>

    <script>
        window.SESSIONIFY_HELP_CONFIG = window.SESSIONIFY_HELP_CONFIG || {
            // Set these values at runtime (e.g., injected by the host app)
            supabaseUrl: 'https://lbkkgwmdauelpkkpruhp.supabase.co',
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxia2tnd21kYXVlbHBra3BydWhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE1MzIyODcsImV4cCI6MjA0NzEwODI4N30.kCLIHf1kvqbwVDvU6SmDRApVQS5sb9vdGzTAOHFVC3Q'
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext } = React;
        const logoColour = '../assets/logo-colour.png';
        const logoWhite = '../assets/logo-white.png';

        const detectEmbeddedContext = () => {
            if (typeof window === 'undefined') return false;
            const configFlag = window.SESSIONIFY_HELP_CONFIG?.embedded;
            if (typeof configFlag === 'boolean') return configFlag;
            const search = window.location?.search || '';
            if (/[?&](source|origin)=app(&|$)/i.test(search)) return true;
            const ua = window.navigator?.userAgent || '';
            return /Electron/i.test(ua);
        };

        const ThemeContext = createContext({ theme: 'light', toggleTheme: () => {} });
        const useTheme = () => useContext(ThemeContext);

        const ThemeProvider = ({ children }) => {
            const getInitialTheme = () => {
                if (typeof window === 'undefined') return 'light';
                const stored = window.localStorage.getItem('Sessionify-theme');
                if (stored === 'light' || stored === 'dark') return stored;
                return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            };

            const [theme, setTheme] = useState(getInitialTheme);

            useEffect(() => {
                if (typeof window === 'undefined') return undefined;
                window.localStorage.setItem('Sessionify-theme', theme);
                document.documentElement.classList.toggle('dark', theme === 'dark');
                document.body.classList.toggle('dark', theme === 'dark');
            }, [theme]);

            useEffect(() => {
                if (typeof window === 'undefined' || !window.matchMedia) return undefined;
                const media = window.matchMedia('(prefers-color-scheme: dark)');
                const listener = (event) => {
                    const stored = window.localStorage.getItem('Sessionify-theme');
                    if (!stored) {
                        setTheme(event.matches ? 'dark' : 'light');
                    }
                };
                media.addEventListener('change', listener);
                return () => media.removeEventListener('change', listener);
            }, []);

            const toggleTheme = useCallback(() => {
                setTheme((curr) => (curr === 'dark' ? 'light' : 'dark'));
            }, []);

            return (
                <ThemeContext.Provider value={{ theme, toggleTheme }}>
                    {children}
                </ThemeContext.Provider>
            );
        };

        const ThemeToggle = () => {
            const { theme, toggleTheme } = useTheme();
            return (
                <button type="button" className="btn btn-ghost hidden sm:inline-flex" onClick={toggleTheme} aria-label="Toggle theme">
                    {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}
                </button>
            );
        };

        const createSupabaseClient = () => {
            try {
                const { supabaseUrl, supabaseAnonKey } = window.SESSIONIFY_HELP_CONFIG || {};
                if (!supabaseUrl || !supabaseAnonKey || !window.supabase) return null;
                return window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
                    auth: {
                        persistSession: false
                    }
                });
            } catch (err) {
                console.warn('Unable to create Supabase client', err);
                return null;
            }
        };

        const HelpCenterPage = () => {
            const { theme } = useTheme();
            const isEmbedded = useMemo(() => detectEmbeddedContext(), []);
            const [articles, setArticles] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [search, setSearch] = useState('');
            const [activeCategory, setActiveCategory] = useState('all');
            const [selectedArticle, setSelectedArticle] = useState(null);
            const supabaseClient = useMemo(() => createSupabaseClient(), []);

            const loadArticles = useCallback(async () => {
                if (!supabaseClient) {
                    setArticles([]);
                    setSelectedArticle(null);
                    setError('Set SESSIONIFY_HELP_CONFIG.supabaseUrl + supabaseAnonKey to load live help articles.');
                    return;
                }
                setLoading(true);
                setError('');
                const { data, error: fetchError } = await supabaseClient
                    .from('help_articles')
                    .select('*')
                    .eq('is_published', true)
                    .order('published_at', { ascending: false });

                if (fetchError) {
                    console.error('Help articles fetch failed', fetchError);
                    setError(fetchError.message || 'Unable to load live help content.');
                    setArticles([]);
                    setSelectedArticle(null);
                } else if (Array.isArray(data) && data.length) {
                    setArticles(data);
                    setSelectedArticle(null);
                } else {
                    setError('No published help articles yet.');
                    setArticles([]);
                    setSelectedArticle(null);
                }
                setLoading(false);
            }, [supabaseClient]);

            useEffect(() => {
                loadArticles();
            }, [loadArticles]);

            const categories = useMemo(() => {
                const base = new Set(['all']);
                articles.forEach((article) => {
                    if (article?.category) base.add(article.category);
                });
                return Array.from(base);
            }, [articles]);

            const filteredArticles = useMemo(() => {
                if (!Array.isArray(articles) || !articles.length) return [];
                const query = search.trim().toLowerCase();
                return articles.filter((article) => {
                    const matchesCategory = activeCategory === 'all'
                        ? true
                        : (article.category || '').toLowerCase() === activeCategory.toLowerCase();
                    if (!matchesCategory) return false;
                    if (!query) return true;
                    const haystack = [
                        article.title,
                        article.summary,
                        article.category,
                        Array.isArray(article.tags) ? article.tags.join(' ') : '',
                        typeof article.content === 'string' ? article.content : (typeof article.content_md === 'string' ? article.content_md : '')
                    ].join(' ').toLowerCase();
                    return haystack.includes(query);
                });
            }, [articles, activeCategory, search]);

            const articleBody = selectedArticle?.content ?? selectedArticle?.content_md ?? '';
            const articleParagraphs = articleBody.split(/\n\n+/).filter(Boolean);

            const handleArticleSelect = (article) => {
                setSelectedArticle(article);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleBackToList = () => {
                setSelectedArticle(null);
            };

            return (
                <div className={`min-h-screen flex flex-col ${theme === 'dark' ? 'bg-slate-900 text-white' : 'bg-gray-50 text-gray-800'}`}>
                    <header className="p-6 flex flex-wrap gap-4 justify-between items-center">
                        <div className="flex items-center gap-3">
                            <img src={theme === 'dark' ? logoWhite : logoColour} alt="Sessionify" className="h-9 w-auto" />
                            <div>
                                <p className="font-semibold leading-tight">Sessionify Help Center</p>
                                <p className="text-sm text-gray-400">Workflow guides for practitioners</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            {!isEmbedded && <ThemeToggle />}
                            {!isEmbedded && (
                                <>
                                    <a href="/" className="btn btn-secondary">Marketing Site</a>
                                    <a href="sessionify://launch" className="btn btn-primary">Launch App</a>
                                </>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 px-4 pb-12">
                        {!selectedArticle && (
                            <section className="max-w-6xl mx-auto text-center py-10">
                                <h1 className="text-4xl font-extrabold mb-4">How can we help?</h1>
                                <p className="text-lg text-gray-500 dark:text-gray-300 max-w-2xl mx-auto">
                                    Search walkthroughs, get product updates, and share articles with your team.
                                </p>
                                <div className="mt-8 max-w-3xl mx-auto relative">
                                    <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
                                    <input
                                        type="text"
                                        className="w-full rounded-full border border-white/10 bg-white/80 dark:bg-slate-800/60 px-12 py-4 text-base focus:outline-none focus:ring-2 focus:ring-indigo-400"
                                        placeholder="Search articles, tags, or categories"
                                        value={search}
                                        onChange={(e) => setSearch(e.target.value)}
                                    />
                                    {loading && (
                                        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-500">Loading‚Ä¶</span>
                                    )}
                                </div>
                                {error && (
                                    <p className="mt-3 text-sm text-amber-400">{error}</p>
                                )}
                            </section>
                        )}

                        <section className="max-w-6xl mx-auto">
                            {!selectedArticle ? (
                                <div>
                                    <div className="flex flex-wrap gap-3 justify-center mb-8">
                                        {categories.map((category) => (
                                            <button
                                                key={category}
                                                type="button"
                                                onClick={() => setActiveCategory(category)}
                                                className={`btn ${activeCategory === category ? 'btn-primary' : 'btn-secondary'}`}
                                            >
                                                {category === 'all' ? 'All topics' : category}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="space-y-4">
                                        {filteredArticles.map((article) => (
                                            <article
                                                key={article.id || article.slug}
                                                className="card text-left border border-transparent hover:border-white/30 transition cursor-pointer"
                                                onClick={() => handleArticleSelect(article)}
                                            >
                                                <div className="flex items-center gap-3 mb-2 text-xs uppercase tracking-wide text-indigo-500">
                                                    <span>{article.category}</span>
                                                    <span>‚Ä¢</span>
                                                    <span>{article.reading_time || 4} min read</span>
                                                </div>
                                                <h3 className="text-2xl font-semibold mb-2">{article.title}</h3>
                                                <p className="text-sm text-gray-500 dark:text-gray-300 mb-4">{article.summary}</p>
                                                <div className="flex flex-wrap gap-2 mb-4">
                                                    {(article.tags || []).map((tag) => (
                                                        <span key={tag} className="px-3 py-1 rounded-full text-xs bg-white/40 dark:bg-white/10 text-gray-700 dark:text-gray-200">
                                                            #{tag}
                                                        </span>
                                                    ))}
                                                </div>
                                                <div className="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
                                                    <span>{article.author || 'Sessionify Team'}</span>
                                                    <span className="font-semibold">Read ‚Üí</span>
                                                </div>
                                            </article>
                                        ))}
                                        {filteredArticles.length === 0 && (
                                            <div className="card text-center opacity-80">
                                                <p>No articles match your filters yet.</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ) : (
                                <article className="card max-w-4xl mx-auto text-left">
                                    <button type="button" className="btn btn-secondary mb-6" onClick={handleBackToList}>
                                        ‚Üê Back to help center
                                    </button>
                                    <div className="text-xs uppercase tracking-wide text-indigo-400 mb-2">{selectedArticle.category}</div>
                                    <h1 className="text-3xl font-bold mb-4">{selectedArticle.title}</h1>
                                    <p className="text-base text-gray-500 dark:text-gray-300 mb-6">{selectedArticle.summary}</p>
                                    <div className="flex flex-wrap gap-2 mb-6">
                                        {(selectedArticle.tags || []).map((tag) => (
                                            <span key={tag} className="px-3 py-1 rounded-full text-xs bg-white/30 dark:bg-white/10 text-gray-700 dark:text-gray-200">
                                                #{tag}
                                            </span>
                                        ))}
                                    </div>
                                    <div className="article-content text-base text-gray-700 dark:text-gray-100">
                                        {(selectedArticle?.content ?? selectedArticle?.content_md ?? '')
                                            .split(/\n\n+/)
                                            .filter(Boolean)
                                            .map((paragraph, idx) => (
                                                <p key={idx}>{paragraph}</p>
                                            ))}
                                    </div>
                                    <div className="mt-10 text-sm text-gray-400 dark:text-gray-500 flex justify-between flex-wrap gap-2">
                                        <span>Author: {selectedArticle.author || 'Sessionify Team'}</span>
                                        <span>{new Date(selectedArticle.published_at || Date.now()).toLocaleDateString()}</span>
                                        <span>{selectedArticle.reading_time || 4} min read</span>
                                    </div>
                                </article>
                            )}
                        </section>
                    </main>

                    <footer className="text-center p-6 text-sm text-gray-500">
                        <p>&copy; {new Date().getFullYear()} Sessionify. Need more help? Email <a className="underline" href="mailto:lunafoxapp@gmail.com">lunafoxapp@gmail.com</a></p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ThemeProvider>
                <HelpCenterPage />
            </ThemeProvider>
        );
    </script>
</body>
</html>
